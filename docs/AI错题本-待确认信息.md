# AI错题本 完整实现 — 待确认信息清单

> 在已有产品规格基础上，实现前还需明确以下信息。先不必写代码，补齐后再开发。

---

## 一、数据与后端

### 1.1 数据库表设计（需你拍板字段）

- **错题本表**（如 `WrongBook`）
  - 已定：`id`、`studentId`、`name`（名称）、`createdAt`
  - 待定：
    - 是否需要 `sortOrder`（数字）用于自定义排序？若需要，默认值（如 0）？
    - 新建错题本时的**默认名称**：`"未命名"` / `"新错题本"` / 其他？

- **错题表**（如 `WrongQuestion`）
  - 已定：`id`、`studentId`、`wrongBookId`（可空 = 未归类）、`content`（题目完整文本）、`name`（知识点/命名）、`createdAt`
  - 待定：
    - 是否需要 `updatedAt`？
    - 是否需要 `sortOrder`（错题本内排序）？若需要，默认值？
    - 新建错题时的**默认名称**：`"未命名"` / `"新错题"` / 其他？
    - 图片：仅用于 OCR 识别，识别后**不存图**只存 `content`，是否确认？若将来要「保留原图」，是否预留字段（如 `imageUrl`）？

### 1.2 API 设计（需你确认约定）

- **错题本**
  - 列表：`GET /api/student/wrong-books`（返回该学生的错题本列表 + 每本下的错题 id/name 或数量）
  - 创建：`POST /api/student/wrong-books`，body 如 `{ name?: string }`，默认名由后端还是前端传？
  - 更新（重命名）：`PATCH /api/student/wrong-books/[id]`，body `{ name: string }`
  - 删除：`DELETE /api/student/wrong-books/[id]`（需二次确认在前端做即可；若错题本内有错题，是**一并删除**还是**禁止删除**直到移空？）

- **错题**
  - 列表：按场景分两种是否都需要？
    - 主页「未归类」：`GET /api/student/wrong-questions?wrongBookId=null` 或单独接口？
    - 某错题本内：`GET /api/student/wrong-questions?wrongBookId=xxx`
  - 创建：`POST /api/student/wrong-questions`，body 如 `{ name?: string, content: string, wrongBookId?: string }`
  - 更新（重命名/改 content/移动所属错题本）：`PATCH /api/student/wrong-questions/[id]`，body 含需改字段
  - 删除：`DELETE /api/student/wrong-questions/[id]`
  - 排序：若支持自定义排序，是否增加 `PATCH /api/student/wrong-books/[id]/order`（错题本顺序）和 `PATCH /api/student/wrong-questions/order`（某本内错题顺序）？请求体格式（如 `{ order: string[] }` id 数组）？

- **鉴权**：所有接口均用现有 `getAuthUser()`，仅 `type === 'student'` 且 `user.id === 资源.studentId` 可操作，是否按此执行？

---

## 二、第三方服务

### 2.1 百度智能云 OCR

- **账号与 Key**：是否已有百度智能云账号？将使用「通用文字识别」还是「高精度版」？API Key / Secret 计划放在 `.env` 的变量名（如 `BAIDU_OCR_API_KEY`、`BAIDU_OCR_SECRET_KEY`）？
- **调用方式**：是否**必须**走后端代理（推荐），即前端上传图片 → 后端调百度 OCR → 返回文本？避免 Key 暴露。
- **图片限制**：单张上传是否足够？图片格式（如 jpg/png）、大小上限（如 4MB）是否需在文档中写明？

### 2.2 DeepSeek（AI 分析 / 举一反三 / 悬浮对话）

- **现有能力**：项目已有 `lib/deepseek.ts` 的 `generateQuestions`、`generateLearningSuggestions` 和 `api/deepseek/generate`。  
  **计划**：新增 3 类调用（不落库）：
  1. **AI 分析**：输入一道题的完整文本，输出详细解析（纯文本或 Markdown，是否需约定？）
  2. **举一反三**：输入一道题，输出 3 道单选题 + 正确答案 + 解析；需约定返回格式（如与现有 `Question` 结构一致），以便前端渲染和**系统自动判题**。
  3. **悬浮对话**：多轮对话，流式或非流式？若流式，是否需要 SSE/WebSocket，还是先做非流式短回复？
- **限流/超时**：是否沿用现有超时（如 90 秒）？错误提示是否统一为「请求超时，请重试」/「服务繁忙，请稍后再试」？

---

## 三、前端 / 交互细节

### 3.1 路由与入口

- **入口**：已确认从学生端 dashboard 点击「AI错题本」进入；当前链接为 `/student/notebook`，是否保持该路由？
- **错题本内页**：是否采用 `/student/notebook/[wrongBookId]`？未归类错题是否用 `/student/notebook` 同一页的「未归类」区域即可，不再单独路由？

### 3.2 未归类与拖拽

- **未归类展示**：主页上未归类错题是单独一块区域（如标题「未归类」下列出），还是与错题本混排？若单独区域，是否允许把错题从错题本**拖回未归类**（即 `wrongBookId = null`）？
- **拖拽**：拖拽错题进错题本 = 移动（调用 PATCH 更新 `wrongBookId`）；拖拽到未归类 = 更新为 `wrongBookId: null`，是否按此实现？

### 3.3 自定义排序

- **排序方式**：仅拖拽排序，还是需要「上移/下移」按钮？拖拽后是否立即调用接口持久化顺序？
- **默认顺序**：无 `sortOrder` 时按 `createdAt` 降序还是升序？

### 3.4 弹窗与流程

- **创建错题**：  
  - 上传图片 → 下一步 → OCR → 编辑框 → 确认保存 → 弹窗内出现「AI分析」「举一反三」「关闭」。  
  - 若 OCR 失败或用户选择「手动输入」：是否在同一弹窗内切到「手动编辑题目」流程（不关弹窗）？
- **删除二次确认**：删除错题本 / 错题时的确认文案是否统一为「确定删除该错题本吗？其下错题将变为未归类」/「确定删除该错题吗？」（若错题本删除策略为「禁止删除非空错题本」，则文案改为「该错题本下还有错题，请先移出或删除」）？

### 3.5 举一反三答题与判题

- **展示**：3 道题是否一题一页（下一步/上一步），还是单页 3 题？作答完成后是否在同一弹窗内展示「对/错 + 解析」？
- **判题**：用户选 A/B/C/D 后，前端用 DeepSeek 返回的 `correctAnswer` 比对即可，是否无需再调接口？

---

## 四、UI / 视觉

### 4.1 与现有风格统一

- 是否与学生端现有页面（如 `dashboard`、`exam`）统一：如 `glass-effect`、`blue-400/cyan-400`、圆角、按钮样式？是否有现成组件（如 Modal、Confirm）需复用或新建？

### 4.2 列表与卡片

- **主页错题本**：以**卡片**（类似 dashboard 的卡片）还是**列表**展示？每项是否显示错题数量？
- **错题本内错题**：以列表（一行一个标题）还是卡片？是否显示摘要（如 content 前 50 字）或仅名称？

### 4.3 悬浮按钮与聊天窗口

- **悬浮按钮**：初始位置（如右下角 24px 边距）、大小、图标（如聊天气泡）是否有要求？是否需要**记住用户拖拽后的位置**（如 localStorage）？
- **聊天窗口**：大小（固定/可拖拽缩放）、位置（如从按钮向上展开）、是否显示历史记录（仅当次会话还是持久化历史）？

---

## 五、错误与边界

### 5.1 网络与接口

- **OCR 失败**：已定允许重试或切换手动输入；是否需要在界面上明确「识别失败，可重试或手动输入」的提示？
- **DeepSeek 超时/限流**：是否统一提示「请求超时，请重试」/「服务繁忙，请稍后再试」？是否需要「重试」按钮？

### 5.2 数据边界

- **空状态**：错题本内无错题时展示空状态；未归类无错题时是否也有一段空状态文案（如「暂无未归类错题」）？
- **错题本为空时删除**：若采用「错题本内有错题则禁止删除」，是否在右击菜单中直接禁用「删除」并 tip「请先移出或删除其下错题」？

---

## 六、其他（可选）

- **导出错题本**（已纳入规格）：导出内容为**错题本身**（该错题本下所有错题的名称、题目文本等），不包含 AI 分析、举一反三等未存储内容。导出格式（TXT / Markdown / PDF 等）与触发入口（错题本内页按钮、右击错题本菜单等）由实现时确定。
- **统计**：是否需要在错题本卡片或内页显示「错题数量」「最近添加时间」？若需要，是否仅用现有列表接口返回的数据即可（如 count、lastCreated）？
- **数学公式**：错题 content 和 AI 分析/举一反三的解析中可能含数学公式，是否与现有 `math-render`/`text-render` 一致，用 LaTeX（如 `$...$`）并前端渲染？

---

## 七、汇总：必答项 vs 可默认项

| 类别 | 建议优先确认的项 |
|------|------------------|
| 数据 | 错题本/错题默认名称；错题本删除策略（删本时其下错题改为未归类 vs 禁止删除非空本）；是否存图 |
| 接口 | 错题本/错题列表与排序 API 路径与 body；排序是否必做 |
| OCR | 百度 OCR 是否已有 Key、调用方式（后端代理）、图片格式与大小限制 |
| DeepSeek | 举一反三返回格式（与现有 Question 一致）；悬浮对话是否流式 |
| 前端 | 路由是否保持 `/student/notebook` 与 `/student/notebook/[wrongBookId]`；未归类是否可拖入；删除确认文案 |
| UI | 错题本/错题列表用卡片还是列表；悬浮按钮是否记位置、聊天是否记历史 |

以上信息确认后，即可按「数据模型 → API → 百度 OCR → DeepSeek 三能力 → 页面与弹窗 → 悬浮按钮」顺序完整实现，且与现有规格一致。
